# 🔘 НАСТРОЙКА КНОПОК В TELEGRAM БОТЕ

## ✅ ЧТО БЫЛО СДЕЛАНО

### 1. Интерактивные кнопки добавлены в сообщения

Каждая заявка с сайта теперь приходит **с кнопками**:

```
🎯 НОВАЯ ЗАЯВКА «Золотой Дуб»
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧮 Источник: Калькулятор
🆔 ID заявки: ZD-1730641234567-A1B2C3D4E
...

[✅ Обработано] [⏳ В работе]
[📞 Позвонил]   [💬 Написал]
[🗑 Удалить]
```

### 2. Обработчики callback_query

Созданы **3 варианта** обработки кнопок:

#### Вариант A: Встроенные кнопки (уже работает)
- ✅ Кнопки отправляются вместе с сообщением
- ✅ Используется Telegram Bot API напрямую
- ❌ **НО:** callback_query НЕ обрабатываются (кнопки видны, но не реагируют)

#### Вариант B: Polling бот (рекомендуется)
- ✅ Полноценный бот с обработкой всех событий
- ✅ Меню администратора (`/start`, `/menu`, `/stats`)
- ✅ Статистика заявок
- ✅ Обработка всех кнопок
- Файл: `telegram-bot/bot.js`

#### Вариант C: Webhook API (для production)
- ✅ Обработка через Next.js API route
- ✅ Не требует отдельного сервера
- ✅ Автоматический restart с Vercel
- Файл: `app/api/telegram-webhook/route.ts`

---

## 🚀 БЫСТРАЯ НАСТРОЙКА

### Вариант 1: Запуск Polling бота (ПРОЩЕ)

```bash
# 1. Перейти в папку бота
cd telegram-bot

# 2. Установить зависимости
npm install

# 3. Запустить бота
npm start
```

**Результат:**
```
════════════════════════════════════════════════
🤖 TELEGRAM БОТ «ЗОЛОТОЙ ДУБ» ЗАПУЩЕН
════════════════════════════════════════════════
📡 Polling: активен
👥 Администраторы: 277767867, 956005680
💾 Хранилище: в памяти (RAM)
════════════════════════════════════════════════

✅ Бот готов к работе!
💡 Отправьте /start боту для проверки
```

**Проверка:**
1. Откройте Telegram
2. Найдите бота (по токену `@your_bot_name`)
3. Отправьте `/start`
4. Должно появиться меню с кнопками

**Тест кнопок:**
1. Заполните форму на сайте
2. Заявка придёт с кнопками
3. Нажмите **✅ Обработано**
4. Сообщение обновится: `✅ СТАТУС: ОБРАБОТАНО`

---

### Вариант 2: Webhook через Next.js (ДЛЯ PRODUCTION)

#### Шаг 1: Деплой на Vercel

```bash
git add .
git commit -m "feat: добавлены интерактивные кнопки в Telegram"
git push origin main
```

Vercel автоматически задеплоит API route: `https://zol-dub.online/api/telegram-webhook`

#### Шаг 2: Настройка webhook в Telegram

```bash
# Установить webhook
curl -X POST "https://api.telegram.org/bot8397994876:AAHpHKfsdPrEvrGAgIVFGwoOKf6Uw1CPMak/setWebhook?url=https://zol-dub.online/api/telegram-webhook"
```

**Ответ (успех):**
```json
{
  "ok": true,
  "result": true,
  "description": "Webhook was set"
}
```

#### Шаг 3: Проверка webhook

```bash
# Получить информацию о webhook
curl "https://api.telegram.org/bot8397994876:AAHpHKfsdPrEvrGAgIVFGwoOKf6Uw1CPMak/getWebhookInfo"
```

**Ответ:**
```json
{
  "ok": true,
  "result": {
    "url": "https://zol-dub.online/api/telegram-webhook",
    "has_custom_certificate": false,
    "pending_update_count": 0,
    "last_error_date": 0
  }
}
```

#### Шаг 4: Health check

```bash
curl "https://zol-dub.online/api/telegram-webhook"
```

**Ответ:**
```json
{
  "status": "ok",
  "applications": 0,
  "admins": 2,
  "timestamp": "2025-11-03T14:30:00.000Z"
}
```

---

## 🧪 ТЕСТИРОВАНИЕ КНОПОК

### 1. Отправить тестовую заявку

Откройте https://zol-dub.online и:
1. Перейдите в калькулятор
2. Выберите параметры
3. Нажмите "Получить точный расчёт"
4. Заполните форму

### 2. Проверить в Telegram

В Telegram должно прийти сообщение с кнопками:

```
🎯 НОВАЯ ЗАЯВКА «Золотой Дуб»
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🧮 Источник: Калькулятор
🆔 ID заявки: ZD-1730641234567-A1B2C3D4E

👤 КОНТАКТНЫЕ ДАННЫЕ:
   • Имя: Тест Тестович
   📞 Телефон: +7 (999) 123-45-67
   ✉️ Email: test@test.ru

[✅ Обработано] [⏳ В работе]
[📞 Позвонил]   [💬 Написал]
[🗑 Удалить]
```

### 3. Тест каждой кнопки

#### ✅ Обработано
- **Нажать:** ✅ Обработано
- **Результат:** Уведомление "✅ Заявка отмечена как обработанная"
- **Изменение:** Добавляется "✅ СТАТУС: ОБРАБОТАНО"
- **Кнопки:** Исчезают

#### ⏳ В работе
- **Нажать:** ⏳ В работе
- **Результат:** Уведомление "🔄 Заявка взята в работу"
- **Изменение:** Добавляется "🔄 СТАТУС: В РАБОТЕ"
- **Кнопки:** Остаются

#### 📞 Позвонил
- **Нажать:** 📞 Позвонил
- **Результат:** Уведомление "📞 Отмечено: позвонили клиенту"
- **Изменение:** Добавляется "📞 Звонок выполнен: 03.11.2025, 14:30"
- **Кнопки:** Остаются

#### 💬 Написал
- **Нажать:** 💬 Написал
- **Результат:** Уведомление "💬 Отмечено: написали клиенту"
- **Изменение:** Добавляется "💬 Сообщение отправлено: 03.11.2025, 14:35"
- **Кнопки:** Остаются

#### 🗑 Удалить
- **Нажать:** 🗑 Удалить
- **Результат:** Уведомление "🗑 Заявка удалена"
- **Изменение:** Добавляется "🗑 ЗАЯВКА УДАЛЕНА"
- **Кнопки:** Исчезают

---

## 🔧 ОТЛАДКА ПРОБЛЕМ

### Проблема 1: Кнопки не появляются

**Причина:** Не обновлён код отправки сообщений

**Решение:**
1. Проверьте `lib/telegram.ts` строка 141-155
2. Убедитесь что есть `reply_markup` с `inline_keyboard`
3. Перезапустите Next.js: `npm run dev`

### Проблема 2: Кнопки есть, но не реагируют

**Причина:** Не запущен обработчик callback_query

**Решение (Polling бот):**
```bash
cd telegram-bot
npm start
```

**Решение (Webhook):**
```bash
# Проверьте что webhook установлен
curl "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo"

# Если нет - установите
curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook?url=https://zol-dub.online/api/telegram-webhook"
```

### Проблема 3: "❌ Нет доступа"

**Причина:** Ваш chat_id не в списке администраторов

**Решение:**
1. Узнайте свой chat_id: https://t.me/userinfobot
2. Добавьте в `.env.local`:
```env
TELEGRAM_CHAT_ID=277767867,956005680,ВАШ_CHAT_ID
```
3. Перезапустите бота

### Проблема 4: Кнопки дублируются

**Причина:** Запущены ОБА обработчика (polling + webhook)

**Решение:** Выберите ОДИН вариант:
- **Polling:** Остановите webhook (`deleteWebhook`)
- **Webhook:** Остановите polling бота (`pm2 stop zoldub-bot`)

**Удалить webhook:**
```bash
curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/deleteWebhook"
```

---

## 📊 МОНИТОРИНГ

### Логи Polling бота

```bash
# Если запущен через npm
# Смотрите в консоли

# Если запущен через PM2
pm2 logs zoldub-bot --lines 100
```

### Логи Webhook (Vercel)

```bash
# В проекте Vercel
vercel logs --app zol-dub

# Или в веб-интерфейсе
https://vercel.com/taley13/zolotoy-dub/logs
```

### Статистика заявок (Polling бот)

Отправьте боту `/stats`:

```
📊 СТАТИСТИКА ЗАЯВОК

📝 Всего заявок: 15
⏳ Новые: 3
🔄 В работе: 5
✅ Обработано: 7
```

---

## 🎯 РЕКОМЕНДАЦИИ

### Для разработки (localhost)

✅ **Используйте Polling бота**
- Проще в настройке
- Не нужен публичный URL
- Видны все логи в реальном времени

```bash
cd telegram-bot
npm run dev  # auto-restart при изменениях
```

### Для production (сервер)

✅ **Используйте Webhook**
- Не требует постоянно запущенного процесса
- Автоматически масштабируется с Vercel
- Меньше нагрузки на Telegram API

```bash
# Один раз настроить
curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook?url=https://zol-dub.online/api/telegram-webhook"

# Всё!
```

---

## 📦 ФАЙЛЫ

```
zolotoy-dub/
├── telegram-bot/               # 🤖 Polling бот (вариант B)
│   ├── bot.js                 # Основной файл бота
│   ├── webhook.js             # Standalone webhook сервер
│   ├── package.json           # Зависимости
│   └── README.md              # Документация бота
│
├── app/api/telegram-webhook/  # 🪝 Webhook API (вариант C)
│   └── route.ts               # Next.js API route
│
├── lib/
│   └── telegram.ts            # ✅ Отправка с кнопками (ОБНОВЛЕНО)
│
└── .env.local                 # 🔐 Токены
```

---

## ✅ ИТОГОВЫЙ ЧЕКЛИСТ

- [x] Кнопки добавлены в `lib/telegram.ts`
- [x] Создан Polling бот (`telegram-bot/bot.js`)
- [x] Создан Webhook API (`app/api/telegram-webhook/route.ts`)
- [x] Документация написана
- [ ] **Выбрать вариант:** Polling ИЛИ Webhook
- [ ] **Запустить обработчик**
- [ ] **Протестировать все кнопки**
- [ ] **Проверить доступ всех администраторов**

---

## 🎉 ГОТОВО!

Теперь у вас полностью рабочие **интерактивные кнопки** в Telegram боте!

**Следующие шаги:**
1. Выберите вариант (Polling или Webhook)
2. Запустите обработчик
3. Отправьте тестовую заявку
4. Нажмите кнопки для проверки

**Вопросы?**  
Проверьте раздел "🔧 ОТЛАДКА ПРОБЛЕМ" выше.


